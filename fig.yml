consul:
    command: -server -bootstrap -advertise $DOCKER_PRIVATE_IP
    image: progrium/consul:latest
    ports:
        - "8300:8300"
        - "8400:8400"
        - "8500:8500"
        - "8600:53/udp"

registrator:
    command: consul://consul:8500
    image: progrium/registrator:latest
    links:
        - consul
    volumes:
        - "/var/run/docker.sock:/tmp/docker.sock"
    environment:
        DOCKER_OPTS: --dns $DOCKER_PRIVATE_IP --dns 8.8.8.8 --dns-search service.consul

postgresql:
    image: orchardup/postgresql:9.3
    ports:
        - 5432:5432
    environment:
        POSTGRESQL_USER: 'didierio'
        POSTGRESQL_PASS: 'didierio'
        POSTGRESQL_DB: 'didierio'
    volumes:
        - data/postgresql:/var/lib/postgresql
    environment:
        SERVICE_NAME: postgresql
        DOCKER_OPTS: --dns $DOCKER_PRIVATE_IP --dns 8.8.8.8 --dns-search service.consul

elasticsearch:
    image: dockerfile/elasticsearch
    volumes:
        - data/elasticsearch:/data
    ports:
        - 9200:9200
        - 9300:9300
    environment:
        SERVICE_NAME: elasticsearch
        DOCKER_OPTS: --dns $DOCKER_PRIVATE_IP --dns 8.8.8.8 --dns-search service.consul

php:
    build: ./docker/php
    links:
        - postgresql:database
        - elasticsearch:search_engine
        - consul
    ports:
        - 9000:9000
    volumes:
        - website:/srv/http/website
        - blog:/srv/http/blog
        - work:/srv/http/work
        - connect:/srv/http/connect
        - media/back:/srv/http/media_back
        - docker/php/php-fpm.sh:/php-fpm
    environment:
        SERVICE_NAME: php-fpm
        DOCKER_OPTS: --dns $DOCKER_PRIVATE_IP --dns 8.8.8.8 --dns-search service.consul

www:
    image: jwilder/nginx-proxy:latest
    volumes:
        - /var/run/docker.sock:/tmp/docker.sock
        - ./log/www:/var/log/nginx
    ports:
        - 80:80
    links:
        - consul
    environment:
        SERVICE_NAME: nginx-proxy
        DOCKER_OPTS: --dns $DOCKER_PRIVATE_IP --dns 8.8.8.8 --dns-search service.consul

website:
    image: nginx:latest
    links:
        - php:webstack_php
        - consul
    volumes:
        - website:/var/www
        - docker/website/nginx.conf:/nginx.conf
        - ./log/website:/var/log/nginx
    ports:
        - 9001:9001
    command: nginx -c /nginx.conf
    environment:
        VIRTUAL_HOST: 'www.dev.didier.io'
        VIRTUAL_PORT: 9001
        SERVICE_NAME: website
        DOCKER_OPTS: --dns $DOCKER_PRIVATE_IP --dns 8.8.8.8 --dns-search service.consul

connect:
    image: nginx:latest
    links:
        - php:webstack_php
        - postgresql:database
        - consul
    volumes:
        - connect:/var/www
        - docker/connect/nginx.conf:/nginx.conf
        - ./log/connect:/var/log/nginx
    ports:
        - 9002:9002
    command: nginx -c /nginx.conf
    environment:
        VIRTUAL_HOST: 'connect.dev.didier.io'
        VIRTUAL_PORT: 9002
        SERVICE_NAME: connect
        DOCKER_OPTS: --dns $DOCKER_PRIVATE_IP --dns 8.8.8.8 --dns-search service.consul

mediaBack:
    image: nginx:latest
    links:
        - php:webstack_php
        - consul
    volumes:
        - media/back:/var/www
        - docker/media_back/nginx.conf:/nginx.conf
        - ./log/media_back:/var/log/nginx
    ports:
        - 9003:9003
    command: nginx -c /nginx.conf
    environment:
        VIRTUAL_HOST: 'media.dev.didier.io'
        VIRTUAL_PORT: 9003
        SERVICE_NAME: media_back
        DOCKER_OPTS: --dns $DOCKER_PRIVATE_IP --dns 8.8.8.8 --dns-search service.consul
